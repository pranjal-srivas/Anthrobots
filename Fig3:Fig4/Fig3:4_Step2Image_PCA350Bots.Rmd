---
title: "PCA"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(FactoMineR)
library(tidyverse)
library(ggbiplot)
library(GGally)
#library(varrank)
library(factoextra)
library(NbClust)
library(RColorBrewer)
library(ggrepel)
library(ggpubr)
library(matlib)
library(BBmisc)
options(scipen = 999)
```

Read raw files

```{r}
mypcadat <- read_csv("AllMov3.csv")
mypcadatA <- read_csv("AllMov4.csv")
```

Append and clean up data from the two files. 

```{r}
mypcadatB <- filter(mypcadatA, Keep == TRUE)
mypcadatB <- mypcadatB[,-19]
mypcadatB <- mypcadatB[complete.cases(mypcadatB), ]
mypcadat2 <- filter(mypcadat, Keep == TRUE)
mypcadat2 <- rbind(mypcadat2, mypcadatB)
nrow(mypcadat2)
mypcadat2$`Cilia Points/Area` <- as.numeric(mypcadat2$`Cilia Points/Area`)
colnames(mypcadat2)[6] <- "CiliaPoints"
colnames(mypcadat2)[7] <- "CiliaPoints/Area"
mypcadat2$`Cilia Distribution Homogeneity` <- as.numeric(mypcadat2$`Cilia Distribution Homogeneity`)
colnames(mypcadat2)[17] <- "CiliaDistributionHomogeneity"
mypcadat2$Noise_Points <- as.numeric(mypcadat2$Noise_Points)
mypcadat2$Category <- ifelse(mypcadat2$Category == "Straight", "Linear", mypcadat2$Category)
colnames(mypcadat2)[13] <- "ShapeSmoothness"
val <- ncol(mypcadat2)
mypcadat3 <- mypcadat2[,c(-1,-2,-3,-4, -val, -val+1, -val+2)]
mypcadat5 <- mypcadat2[,c(5,8,11,12,13,15)]
head(mypcadat3) 
val <- ncol(mypcadat2)
mypcadat4 <- mypcadat2[,c(-1,-2,-3,-4,-5,-8,-12, -val, -val+1, -val+2, -val+3, -val+6,-val+7)] 
mypcadat3$CilArPerSurf <- mypcadat3$`Cilia SA`/mypcadat3$SurfaceArea
tail(mypcadat4)
nrow(mypcadat4)
```


Calculate PCA, the loadings and the length of vector in PC1-PC2 space. 

```{r}
pca <- prcomp(mypcadat4, center = TRUE,scale = TRUE)
summary(pca)
comp <- data.frame(pca$x[,1:8])
pca$rotation
sort(sqrt((pca$rotation[,1])^2 + (pca$rotation[,2])^2))
```

```{r}
plotit <- ggbiplot::ggbiplot(pca, labels.size = 0.5, varname.size = 2, alpha = 0.75, varname.adjust = -1.1)+xlim(-4.5,4.5)+ scale_y_reverse()+scale_x_reverse(limits = c(4.5,-4.5))
plotit
```
Get number of clusters if not known

```{r}
res <- NbClust(comp, method = "ward.D2", index = "alllong") #alpha value 
```

Picks the bots to highlight yellow

```{r}
indexname <- which(mypcadat2$Category != "Mover" & mypcadat2$Category != "Nonmover")
vecfincol <- mypcadat2$Category
vecfincol[indexname] <- mypcadat2$Name[indexname]
```

Cluster and Plot the clustered PCA.

```{r}
nrow(comp)
hc <- hclust(dist(comp), "ward.D2")
memb <- cutree(hc, k = 3)
memb <- ifelse(memb == 2, 4, memb)
memb <- ifelse(memb == 3, 2, memb)
memb <- ifelse(memb == 1, 3, memb)
memb <- ifelse(memb == 4, 1, memb)
#memb <- ifelse(memb == 1, 4, memb)
#memb <- ifelse(memb == 2, 1, memb)
#memb <- ifelse(memb == 4, 2, memb)
#memb <- ifelse(memb == 2, 4, memb)
#memb <- ifelse(memb == 3, 2, memb)
#memb <- ifelse(memb == 4, 3, memb)
g <- ggbiplot::ggbiplot(pca, choices = 1:2, groups =as.factor(memb), labels.size = 0.5, alpha = 0.75, varname.size = 2, ellipse = TRUE, ellipse.prob =0.90, varname.adjust = -1.1)+scale_y_reverse()+scale_x_reverse(limits = c(4.5,-4.5)) 
sizes <- if_else(mypcadat2$Category == "Mover", 0, 1)
colors <- if_else(mypcadat2$Category == "Mover", "black", if_else(mypcadat2$Category == "Circular", "dark red", "turquoise"))
g
gg <- g+geom_point(aes(shape = mypcadat2$Category), size = sizes)+scale_shape_manual(values = c(17,3, 16,15))+geom_point(shape = ifelse(vecfincol != "Mover" & vecfincol != "Nonmover", 21, NA), lwd=2, color = "yellow")

gg
```

Get meta-info on size of clusters, bits in each cluster

```{r}
mypcadat2_0 <- mypcadat2
nrow(mypcadat2_0)
mypcadat2_0$memb <- memb
nrow(filter(mypcadat2_0, memb == 1))
nrow(filter(mypcadat2_0, memb == 2))
nrow(filter(mypcadat2_0, memb == 3))
nrow(filter(mypcadat2_0, memb == 1))/nrow(mypcadat2_0)
nrow(filter(mypcadat2_0, memb == 2))/nrow(mypcadat2_0)
nrow(filter(mypcadat2_0, memb == 3))/nrow(mypcadat2_0)
```

Plot the boxplot and get the p and p.adj values if comparing cluster 1,2 and 3

```{r}
rawdatfin <- mypcadat4
colnam <- colnames(mypcadat4)
rawdatfin$members <- as.factor(memb)
finalgrid <- pivot_longer(rawdatfin, colnam, names_to = "Key")
```

```{r}
options(scipen = 6)
p <- ggplot(finalgrid, aes(x = members, y = value, fill = members)) + geom_boxplot() +
facet_wrap(~Key, scales="free_y", strip.position = "top")
my_comparisons <- list(c("1", "2"), c("2", "3"), c("1", "3"))
p
p2 <- p+stat_compare_means(aes(label = ..p.signif..), method = "wilcox.test", vjust = 1.2, hjust = 1.1, comparisons = my_comparisons, p.adjust.method = "holm")
rawdatfin <- as.data.frame(rawdatfin)
p2
colnames(rawdatfin) <- str_replace_all(colnames(rawdatfin), " ", "")
compared <- compare_means(c(CiliaPoints, CiliaPoints/Area, Noise_Points, MaxRadius, Aspect, ShapeSmoothness, Polarity, CiliaDistributionHomogeneity) ~ members, comparisons = my_comparisons, method='wilcox.test', data = rawdatfin, p.adjust.method = "holm")
compared[c(1,2,3,5)]
```

Plot the boxplot and get the p and p.adj values if comparing cluster Nonmovers,Linears and Circulars

```{r}
rawdatfin <- mypcadat2
rawdatfin$members <- as.factor(memb)
rawdatfin2 <- filter(rawdatfin, Category %in% c("Linear", "Circular"))
rawdatfin_non <- filter(rawdatfin, Category == "Nonmover")
rawdatfin <- rbind(rawdatfin_non,rawdatfin2)
rawdatfin0 <- rawdatfin[,c(-1,-2,-4,-5,-8,-12, -val, -val+1, -val+2, -val+3, -val+6,-val+7,-ncol(rawdatfin))]
rawdatfin0$Category <- factor(rawdatfin$Category, levels=c("Nonmover", "Linear", "Circular"))
colnam <- colnames(rawdatfin0)[-1]
finalgrid <- pivot_longer(rawdatfin0, colnam, names_to = "Key")
```

```{r}
p <- ggplot(finalgrid, aes(x = Category, y = value, fill = Category)) + geom_boxplot() +
facet_wrap(~Key, scales="free_y", strip.position = "top")
my_comparisons <- list(c("Circular", "Linear"), c("Linear", "Nonmover"), c("Circular", "Nonmover"))
p
p2 <-p+stat_compare_means(aes(label = ..p.signif..), method = "wilcox.test", vjust = 1.2, hjust = 1.1, comparisons = my_comparisons, p.adjust.method = "holm")
rawdatfin <- as.data.frame(rawdatfin)
p2
colnames(rawdatfin) <- str_replace_all(colnames(rawdatfin), " ", "")
compared <- compare_means(c(CiliaPoints, CiliaPoints/Area, Noise_Points, MaxRadius, Aspect, ShapeSmoothness, Polarity, CiliaDistributionHomogeneity) ~ Category, comparisons = my_comparisons, method='wilcox.test', data = rawdatfin0, p.adjust.method = "holm")
compared[,c(1,2,3,5,7)]
```

Run the fisher test for proportion of nonmovers, overall and pairwise. 

```{r}
library(rstatix)
dt <- mypcadat2[,c(1,2,3)]
dt$Member <- memb
dt
```

```{r}
library(rlang)
library(data.table)
library(ggmosaic)
dt <- setDT(dt)
dt[, Mover := Category != "Nonmover"]
ct <- xtabs(~ Mover + Member, data = dt)
addmargins(ct)
ggplot(dt) +
  geom_mosaic(aes(x = product(Mover, Member), fill = Mover)) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Morphological category", y = "Does the bot move?") + 
  theme_light(base_size = 16) +
  theme(legend.position = "none")
```
```{r}
pairwise_fisher_test(ct, detailed = TRUE)
fisher_test(ct, detailed = TRUE)
```

Run the fisher test for proportion of circular/linear, between cluster 2 and 3. 

```{r}
ct2 <- xtabs(~ Category + Member, data = dt[Category == "Circular" | Category == "Linear"])
addmargins(ct2)
ggplot(dt[Category == "Circular" | Category == "Linear"]) +
  geom_mosaic(aes(x = product(Category, Member), fill = Category)) +
  scale_fill_brewer(palette = "Dark2") +
  labs(x = "Morphological category", y = "Movement category") + 
  theme_light(base_size = 16) +
  theme(legend.position = "none")
```

```{r}
fisher_test(ct2, detailed = TRUE)
```

